<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner QR</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>

<div class="app scanner-page">
  <header>
    <button onclick="window.location.href='index.html'" class="back-btn">‚Üê Indietro</button>
    <h1>Scansiona QR Code</h1>
  </header>

  <div class="scanner-container">
    <div id="reader"></div>
    
    <!-- Modal Conferma -->
    <div id="confirmModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-icon">üõí</div>
        <h2 id="confirmTitle">Conferma Acquisto</h2>
        <p id="confirmMessage" class="confirm-message"></p>
        <div class="confirm-details">
          <div class="detail-row">
            <span>Costo:</span>
            <strong id="confirmCosto">0 token</strong>
          </div>
          <div class="detail-row">
            <span>Saldo attuale:</span>
            <strong id="confirmSaldoAttuale">0 token</strong>
          </div>
          <div class="detail-row highlight">
            <span>Nuovo saldo:</span>
            <strong id="confirmNuovoSaldo">0 token</strong>
          </div>
        </div>
        <div class="modal-buttons">
          <button id="btnConferma" class="btn-confirm">‚úÖ Conferma</button>
          <button id="btnAnnulla" class="btn-cancel">‚ùå Annulla</button>
        </div>
      </div>
    </div>
    
    <div id="result" class="result-box hidden">
      <div class="result-icon">‚úÖ</div>
      <h2 id="resultTitle">Scansione completata!</h2>
      <p id="resultMessage"></p>
      <div class="result-buttons">
        <button onclick="location.reload()" class="btn-primary">Scansiona Altro</button>
        <button onclick="window.location.href='index.html'" class="btn-secondary">Torna alla Dashboard</button>
      </div>
    </div>
  </div>

  <!-- Audio per feedback -->
  <audio id="successSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBzaM0fPTgjMGHm7A7+OZUQ0PVqvm7q1aFApCm+DyvWwhCDOMz/PWhzQHH2698N6WTQwPU6vl7q1ZFQlBnN/yuW4fCDSLzfPUgzIGIG/A7+OVTwwOUqrk7axYFQlBnN7xu24fCDGLzfPTgzIGIG6/7+OUTQ0OUqnj7KtYFAo+nN7xt24gCDKKzfPSgjEGIG6+7uSTTA0PUank66pXEwo9m93wtW0fCDKKzPPSgTAFIW2+7uOSTA0OUKni66lWEwk8mtzus2weCC+IyvLPfS4EH2y77d+QSgsLTqfd6qVTEAc5ltrtrlgVCDODx+zHcSQFKXG57NyLPgcVZrDn4ptXEwg7ndnqpVIQBjiQ1ezEayUGLXfB6tiMQAoUY67k4JdUEAc6mtjpn1ARBjaOze7AZiEGMXu96NOMQQsVY67j3ZRSEAg7mtfnm08RBjaOze6+ZB8GM3q96NKLQAsUYq3i3JFREAc6mdfnmU4RBTaMze29YyAHNHm86M+JQAwTYavh2pBRDwc5mNbmlkwQBTWLze26YR8HNHi76M2IQAwSYKvg2Y9QDgc4ltXllUoQBDSKzO23YB4HNHe56MuHPgsQX6rf2I1PDgY3lNTjk0kPBDKJy+y1Xh0GNHa56MqGPgoQXqne14xODQY3k9PikkgPAzGIyuy0XBsGNXW358mFPQkPXafe1otNDAU3ktLhkUcOAzCHyeuzWhsGNnS35siEPAkOXKbb1YlLCwQ2j9DgkEYOAi+Gx+qxWBoFNnK15saEOwgNXKba1IlLCgM1js/fjkUOAi6Fxumv">
    </source>
  </audio>
  <audio id="errorSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACAgICAgICAgICAgICAgICAfn59fHt6enl4d3Z1dHNyb21qaWdlY2BcWFRQS0Y/Ojcu">
    </source>
  </audio>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { 
    getFirestore, 
    doc, 
    getDoc, 
    updateDoc,
    collection,
    addDoc,
    query,
    where,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDEN54mTu8CdsWoWvw0sP6xAfL2NRlAN9M",
    authDomain: "assemblea-token.firebaseapp.com",
    projectId: "assemblea-token",
    storageBucket: "assemblea-token.firebasestorage.app",
    messagingSenderId: "682305266240",
    appId: "1:682305266240:web:30a93bb05c10d1a2aeb5a5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Verifica login studente
  const studenteID = localStorage.getItem("studenteID");
  const ruoloUtente = localStorage.getItem("ruoloUtente");
  
  if (!studenteID || ruoloUtente !== "studente") {
    alert("‚ö†Ô∏è Solo gli studenti possono scansionare QR codes");
    window.location.href = "login.html";
  }

  let scannerAttivo = true;
  let html5QrCode;
  let qrDataTemp = null;
  let qrInfoTemp = null;

  const confirmModal = document.getElementById("confirmModal");
  const btnConferma = document.getElementById("btnConferma");
  const btnAnnulla = document.getElementById("btnAnnulla");
  const successSound = document.getElementById("successSound");
  const errorSound = document.getElementById("errorSound");

  // Inizializza lo scanner
  function inizializzaScanner() {
    html5QrCode = new Html5Qrcode("reader");
    
    const config = {
      fps: 10,
      qrbox: { width: 250, height: 250 },
      aspectRatio: 1.0
    };

    html5QrCode.start(
      { facingMode: "environment" },
      config,
      onScanSuccess,
      onScanError
    ).catch(err => {
      console.error("Errore avvio scanner:", err);
      alert("‚ùå Errore nell'avvio della fotocamera. Verifica i permessi.");
    });
  }

  // Successo scansione
  async function onScanSuccess(decodedText) {
    if (!scannerAttivo) return;
    scannerAttivo = false;

    // Ferma lo scanner
    html5QrCode.stop();

    await processaQRCode(decodedText);
  }

  // Errore scansione (ignora)
  function onScanError(error) {
    // Ignora errori di scansione continua
  }

  // Processa il QR code scansionato
  async function processaQRCode(qrData) {
    try {
      console.log("QR scansionato:", qrData);

      // Cerca il QR code nel database
      const q = query(
        collection(db, "qrcodes"),
        where("codice", "==", qrData),
        where("attivo", "==", true)
      );

      const qrSnap = await getDocs(q);

      if (qrSnap.empty) {
        errorSound.play();
        mostraRisultato("‚ùå", "QR Code non valido", "Questo QR non √® registrato nel sistema.", false);
        return;
      }

      const qrCodeData = qrSnap.docs[0].data();
      const costoToken = qrCodeData.costo || 1;
      const descrizione = qrCodeData.descrizione || "Servizio";

      // Verifica saldo studente
      const studenteRef = doc(db, "studenti", studenteID);
      const studenteSnap = await getDoc(studenteRef);

      if (!studenteSnap.exists()) {
        errorSound.play();
        mostraRisultato("‚ùå", "Errore", "Studente non trovato.", false);
        return;
      }

      const tokenAttuali = studenteSnap.data().token || 0;

      if (tokenAttuali < costoToken) {
        errorSound.play();
        mostraRisultato("‚ùå", "Token insufficienti", `Servizio: ${descrizione}\nCosto: ${costoToken} token\nDisponibili: ${tokenAttuali} token`, false);
        return;
      }

      // Salva dati temporanei e mostra conferma
      qrDataTemp = qrData;
      qrInfoTemp = {
        descrizione,
        costoToken,
        tokenAttuali,
        studenteRef
      };

      mostraConferma(descrizione, costoToken, tokenAttuali);

    } catch (error) {
      console.error("Errore processamento QR:", error);
      errorSound.play();
      mostraRisultato("‚ùå", "Errore", "Si √® verificato un errore. Riprova.", false);
    }
  }

  // Mostra modal conferma
  function mostraConferma(descrizione, costo, saldoAttuale) {
    const nuovoSaldo = saldoAttuale - costo;

    document.getElementById("confirmMessage").textContent = descrizione;
    document.getElementById("confirmCosto").textContent = `${costo} token`;
    document.getElementById("confirmSaldoAttuale").textContent = `${saldoAttuale} token`;
    document.getElementById("confirmNuovoSaldo").textContent = `${nuovoSaldo} token`;

    confirmModal.classList.remove("hidden");
  }

  // Conferma acquisto
  btnConferma.addEventListener("click", async () => {
    btnConferma.disabled = true;
    btnConferma.textContent = "‚è≥ Elaborazione...";

    try {
      const { descrizione, costoToken, tokenAttuali, studenteRef } = qrInfoTemp;
      const nuoviToken = tokenAttuali - costoToken;

      // Decrementa i token
      await updateDoc(studenteRef, { token: nuoviToken });

      // Registra la transazione
      await addDoc(collection(db, "transazioni"), {
        studente: studenteID,
        descrizione: descrizione,
        variazione: -costoToken,
        timestamp: new Date(),
        qrcode: qrDataTemp
      });

      // Nascondi modal e mostra successo
      confirmModal.classList.add("hidden");
      successSound.play();
      
      mostraRisultato(
        "‚úÖ", 
        "Acquisto completato!", 
        `${descrizione}\n-${costoToken} token\nNuovo saldo: ${nuoviToken} token`,
        true
      );

    } catch (error) {
      console.error("Errore completamento acquisto:", error);
      confirmModal.classList.add("hidden");
      errorSound.play();
      mostraRisultato("‚ùå", "Errore", "Errore durante l'acquisto. Riprova.", false);
    }
  });

  // Annulla acquisto
  btnAnnulla.addEventListener("click", () => {
    confirmModal.classList.add("hidden");
    scannerAttivo = true;
    
    // Riavvia scanner
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 },
      onScanSuccess,
      onScanError
    );
  });

  // Mostra risultato
  function mostraRisultato(icon, title, message, success) {
    document.getElementById("reader").style.display = "none";
    document.getElementById("result").classList.remove("hidden");
    
    const resultIcon = document.querySelector(".result-icon");
    resultIcon.textContent = icon;
    resultIcon.style.color = success ? "#10b981" : "#ef4444";
    
    document.getElementById("resultTitle").textContent = title;
    document.getElementById("resultMessage").textContent = message;
  }

  // Avvia lo scanner
  inizializzaScanner();
</script>

</body>
</html>
