<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin</title>
  <link rel="stylesheet" href="style.css">
  <script src="session-manager.js"></script>
</head>
<body>

<div class="app">
  <header>
    <h1>Pannello Admin</h1>
    <button id="logoutBtn" class="logout-btn">Esci</button>
  </header>

  <div class="admin-actions">
    <button onclick="window.location.href='genera-qr.html'" class="btn-qr">
      üì± Genera QR Code
    </button>
    <button onclick="window.location.href='crea-account.html'" class="btn-qr" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);">
      üë• Crea Account
    </button>
    <button onclick="window.location.href='statistiche.html'" class="btn-stats">
      üìä Statistiche
    </button>
  </div>

  <div class="search-filters">
    <input type="text" id="searchInput" placeholder="üîç Cerca studente..." class="search-input">
    <select id="classeFilter" class="filter-select">
      <option value="">Tutte le classi</option>
    </select>
  </div>

  <div id="listaStudenti" class="lista-studenti">
    <div class="loading-admin">Caricamento studenti...</div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { 
    getFirestore, 
    collection,
    getDocs,
    doc,
    updateDoc,
    addDoc,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDEN54mTu8CdsWoWvw0sP6xAfL2NRlAN9M",
    authDomain: "assemblea-token.firebaseapp.com",
    projectId: "assemblea-token",
    storageBucket: "assemblea-token.firebasestorage.app",
    messagingSenderId: "682305266240",
    appId: "1:682305266240:web:30a93bb05c10d1a2aeb5a5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // üîí PROTEZIONE: Verifica se l'admin √® loggato
  const adminID = localStorage.getItem("studenteID");
  const isAdmin = localStorage.getItem("isAdmin");
  
  // Verifica sessione valida
  if (typeof window.verificaSessione === 'function' && !window.verificaSessione()) {
    window.location.href = "login.html";
  }
  
  if (!adminID || isAdmin !== "true") {
    alert("‚ö†Ô∏è Accesso negato. Solo per admin.");
    window.location.href = "login.html";
  }

  const listaStudenti = document.getElementById("listaStudenti");
  const logoutBtn = document.getElementById("logoutBtn");
  const searchInput = document.getElementById("searchInput");
  const classeFilter = document.getElementById("classeFilter");

  let tuttiStudenti = []; // Array con tutti gli studenti

  // Logout
  function logout() {
    localStorage.removeItem("studenteID");
    localStorage.removeItem("studenteNome");
    localStorage.removeItem("isAdmin");
    localStorage.removeItem("ruoloUtente");
    window.location.href = "login.html";
  }

  logoutBtn.addEventListener("click", () => {
    if (confirm("Vuoi davvero uscire?")) {
      logout();
    }
  });

  // Funzione per caricare tutti gli studenti
  async function caricaStudenti() {
    try {
      listaStudenti.innerHTML = '<div class="loading-admin">Caricamento...</div>';

      const q = query(
        collection(db, "studenti"), 
        where("attivo", "==", true),
        where("ruolo", "==", "studente") // Solo studenti, non admin/venditori
      );
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        listaStudenti.innerHTML = '<div class="no-data">Nessuno studente trovato</div>';
        return;
      }

      tuttiStudenti = [];
      const classiSet = new Set();

      snapshot.forEach(docSnap => {
        const studenteID = docSnap.id;
        const data = docSnap.data();
        
        tuttiStudenti.push({
          id: studenteID,
          ...data
        });

        // Raccogli tutte le classi uniche
        if (data.classe) {
          classiSet.add(data.classe);
        }
      });

      // Popola il filtro classi
      classeFilter.innerHTML = '<option value="">Tutte le classi</option>';
      Array.from(classiSet).sort().forEach(classe => {
        const option = document.createElement("option");
        option.value = classe;
        option.textContent = classe;
        classeFilter.appendChild(option);
      });

      // Mostra tutti gli studenti
      mostraStudenti(tuttiStudenti);

    } catch (error) {
      console.error("Errore caricamento studenti:", error);
      listaStudenti.innerHTML = '<div class="error-admin">‚ùå Errore di caricamento</div>';
    }
  }

  // Funzione per mostrare gli studenti filtrati
  function mostraStudenti(studenti) {
    if (studenti.length === 0) {
      listaStudenti.innerHTML = '<div class="no-data">Nessuno studente trovato</div>';
      return;
    }

    listaStudenti.innerHTML = '';

    studenti.forEach(studente => {
      const card = document.createElement("div");
      card.className = "studente";
      card.style.cursor = "pointer";
      card.innerHTML = `
        <div class="studente-info" data-id="${studente.id}">
          <strong>${studente.nome || 'Nome non disponibile'}</strong>
          <small>${studente.classe || 'N/A'}</small>
        </div>
        <div class="azioni">
          <span class="token-count">${studente.token || 0}</span>
          <button class="btn-add" data-id="${studente.id}">+4</button>
          <button class="btn-remove" data-id="${studente.id}">-1</button>
        </div>
      `;

      listaStudenti.appendChild(card);
    });

    // Event listener per vedere storico studente
    document.querySelectorAll('.studente-info').forEach(info => {
      info.addEventListener('click', () => {
        const studenteId = info.dataset.id;
        window.location.href = `storico-studente.html?id=${studenteId}`;
      });
    });

    // Aggiungi event listener ai bottoni
    document.querySelectorAll('.btn-add').forEach(btn => {
      btn.addEventListener('click', () => aggiungiToken(btn.dataset.id, 4));
    });

    document.querySelectorAll('.btn-remove').forEach(btn => {
      btn.addEventListener('click', () => rimuoviToken(btn.dataset.id, 1));
    });
  }

  // Funzione per filtrare studenti
  function filtraStudenti() {
    const searchText = searchInput.value.toLowerCase().trim();
    const classeSelezionata = classeFilter.value;

    let studentiFiltrati = tuttiStudenti;

    // Filtro per nome
    if (searchText) {
      studentiFiltrati = studentiFiltrati.filter(s => 
        (s.nome || '').toLowerCase().includes(searchText) ||
        (s.username || '').toLowerCase().includes(searchText)
      );
    }

    // Filtro per classe
    if (classeSelezionata) {
      studentiFiltrati = studentiFiltrati.filter(s => s.classe === classeSelezionata);
    }

    mostraStudenti(studentiFiltrati);
  }

  // Event listeners per filtri
  searchInput.addEventListener('input', filtraStudenti);
  classeFilter.addEventListener('change', filtraStudenti);

  // Funzione per aggiungere token
  async function aggiungiToken(studenteID, quantita) {
    try {
      const ref = doc(db, "studenti", studenteID);
      const snap = await getDocs(query(collection(db, "studenti"), where("__name__", "==", studenteID)));
      
      if (snap.empty) {
        alert("‚ùå Studente non trovato");
        return;
      }

      const currentToken = snap.docs[0].data().token || 0;
      const newToken = currentToken + quantita;

      await updateDoc(ref, { token: newToken });

      // Aggiungi transazione
      await addDoc(collection(db, "transazioni"), {
        studente: studenteID,
        descrizione: "Quota Assemblea",
        variazione: quantita,
        timestamp: new Date()
      });

      // Aggiorna solo quello studente nella UI
      const studenteIndex = tuttiStudenti.findIndex(s => s.id === studenteID);
      if (studenteIndex !== -1) {
        tuttiStudenti[studenteIndex].token = newToken;
        filtraStudenti();
      }
      
      alert(`‚úÖ +${quantita} token aggiunti!`);

    } catch (error) {
      console.error("Errore aggiunta token:", error);
      alert("‚ùå Errore durante l'operazione");
    }
  }

  // Funzione per rimuovere token
  async function rimuoviToken(studenteID, quantita) {
    try {
      const ref = doc(db, "studenti", studenteID);
      const snap = await getDocs(query(collection(db, "studenti"), where("__name__", "==", studenteID)));
      
      if (snap.empty) {
        alert("‚ùå Studente non trovato");
        return;
      }

      const currentToken = snap.docs[0].data().token || 0;
      
      if (currentToken < quantita) {
        alert("‚ùå Token insufficienti");
        return;
      }

      const newToken = currentToken - quantita;

      await updateDoc(ref, { token: newToken });

      // Aggiungi transazione
      await addDoc(collection(db, "transazioni"), {
        studente: studenteID,
        descrizione: "Rimosso dall'admin",
        variazione: -quantita,
        timestamp: new Date()
      });

      // Aggiorna solo quello studente nella UI
      const studenteIndex = tuttiStudenti.findIndex(s => s.id === studenteID);
      if (studenteIndex !== -1) {
        tuttiStudenti[studenteIndex].token = newToken;
        filtraStudenti();
      }
      
      alert(`‚úÖ -${quantita} token rimosso!`);

    } catch (error) {
      console.error("Errore rimozione token:", error);
      alert("‚ùå Errore durante l'operazione");
    }
  }

  // Carica gli studenti all'avvio
  caricaStudenti();
</script>

</body>
</html>
