<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crea Account</title>
  <link rel="stylesheet" href="style.css">
  <script src="session-manager.js"></script>
  <style>
    .create-account-container {
      padding: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .method-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .method-card {
      background: white;
      border: 3px solid #e2e8f0;
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    body.dark-mode .method-card {
      background: #2d3748;
      border-color: #4a5568;
    }

    .method-card:hover {
      border-color: #3b82f6;
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
    }

    .method-card.active {
      border-color: #3b82f6;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }

    body.dark-mode .method-card.active {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    }

    .method-card .icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    .method-card h3 {
      color: #1e293b;
      margin-bottom: 10px;
    }

    body.dark-mode .method-card h3 {
      color: #f1f5f9;
    }

    .method-card p {
      color: #64748b;
      font-size: 0.9rem;
    }

    .creation-section {
      background: white;
      border-radius: 25px;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      display: none;
    }

    body.dark-mode .creation-section {
      background: #2d3748;
    }

    .creation-section.active {
      display: block;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-field label {
      font-weight: 600;
      color: #475569;
      font-size: 0.9rem;
    }

    body.dark-mode .form-field label {
      color: #94a3b8;
    }

    .form-field input,
    .form-field select {
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    body.dark-mode .form-field input,
    body.dark-mode .form-field select {
      background: #1e293b;
      border-color: #4a5568;
      color: #f1f5f9;
    }

    .form-field input:focus,
    .form-field select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .quick-add-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
      width: 100%;
    }

    .quick-add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    .csv-upload-area {
      border: 3px dashed #cbd5e1;
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .csv-upload-area:hover {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.05);
    }

    .csv-upload-area.dragover {
      border-color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }

    .csv-template-btn {
      background: #f1f5f9;
      color: #475569;
      border: 2px solid #e2e8f0;
      padding: 12px 25px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 15px;
    }

    .csv-template-btn:hover {
      background: #e2e8f0;
      transform: translateY(-2px);
    }

    .preview-table {
      overflow-x: auto;
      margin-top: 20px;
    }

    .preview-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .preview-table th,
    .preview-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    .preview-table th {
      background: #f8fafc;
      font-weight: 700;
      color: #1e293b;
    }

    body.dark-mode .preview-table th {
      background: #1e293b;
      color: #f1f5f9;
    }

    body.dark-mode .preview-table td {
      border-color: #4a5568;
      color: #e2e8f0;
    }

    .bulk-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .bulk-actions button {
      flex: 1;
      padding: 15px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }

    .btn-import {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      box-shadow: 0 6px 15px rgba(59, 130, 246, 0.3);
    }

    .btn-import:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-cancel {
      background: #f1f5f9;
      color: #475569;
    }

    .btn-cancel:hover {
      background: #e2e8f0;
    }

    .btn-back-admin {
      padding: 10px 20px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border: none;
      border-radius: 10px;
      color: white;
      font-family: inherit;
      font-weight: 700;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-back-admin:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    .success-message {
      background: rgba(16, 185, 129, 0.1);
      border: 2px solid #10b981;
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      color: #065f46;
      font-weight: 600;
      text-align: center;
    }

    body.dark-mode .success-message {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .auto-generate {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .auto-generate-card {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
    }

    body.dark-mode .auto-generate-card {
      background: #1e293b;
      border-color: #4a5568;
    }

    .auto-generate-card h4 {
      color: #1e293b;
      margin-bottom: 15px;
    }

    body.dark-mode .auto-generate-card h4 {
      color: #f1f5f9;
    }

    .auto-generate-card input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 15px;
    }

    body.dark-mode .auto-generate-card input {
      background: #0f172a;
      border-color: #4a5568;
      color: #f1f5f9;
    }

    .generate-btn {
      width: 100%;
      padding: 12px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .generate-btn:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>

<div class="create-account-container">
  <!-- Header -->
  <div class="dashboard-header" style="margin-bottom: 30px;">
    <div class="operator-info">
      <h1>üë• CREAZIONE ACCOUNT</h1>
      <p>Aggiungi studenti e venditori velocemente</p>
    </div>
    <div class="header-actions">
      <button class="btn-back-admin" onclick="window.location.href='admin.html'">
        ‚Üê TORNA AD ADMIN
      </button>
    </div>
  </div>

  <!-- Method Selector -->
  <div class="method-selector">
    <div class="method-card active" onclick="selectMethod('quick')">
      <div class="icon">‚ö°</div>
      <h3>Aggiunta Veloce</h3>
      <p>Crea 1 account alla volta con form rapido</p>
    </div>

    <div class="method-card" onclick="selectMethod('bulk')">
      <div class="icon">üìã</div>
      <h3>Import CSV</h3>
      <p>Carica un file CSV con tanti account</p>
    </div>

    <div class="method-card" onclick="selectMethod('auto')">
      <div class="icon">ü§ñ</div>
      <h3>Generazione Auto</h3>
      <p>Genera credenziali automatiche per classe</p>
    </div>
  </div>

  <!-- Quick Add Section -->
  <div id="quickSection" class="creation-section active">
    <h2 style="margin-bottom: 20px; color: #1e293b;">‚ö° Aggiunta Veloce</h2>
    
    <div class="form-grid">
      <div class="form-field">
        <label>Username *</label>
        <input type="text" id="quickUsername" placeholder="mario.rossi">
      </div>
      <div class="form-field">
        <label>Password *</label>
        <input type="text" id="quickPassword" placeholder="1234">
      </div>
      <div class="form-field">
        <label>Nome Completo *</label>
        <input type="text" id="quickNome" placeholder="Mario Rossi">
      </div>
      <div class="form-field">
        <label>Classe *</label>
        <input type="text" id="quickClasse" placeholder="3B">
      </div>
      <div class="form-field">
        <label>Ruolo *</label>
        <select id="quickRuolo">
          <option value="studente">Studente</option>
          <option value="venditore">Venditore</option>
        </select>
      </div>
      <div class="form-field">
        <label>Token Iniziali</label>
        <input type="number" id="quickToken" value="0" min="0">
      </div>
    </div>

    <button class="quick-add-btn" onclick="quickAdd()">
      ‚úÖ CREA ACCOUNT
    </button>

    <div id="quickSuccess" class="success-message" style="display:none;">
      ‚úÖ Account creato con successo!
    </div>
  </div>

  <!-- Bulk CSV Section -->
  <div id="bulkSection" class="creation-section">
    <h2 style="margin-bottom: 20px; color: #1e293b;">üìã Import da CSV</h2>

    <div class="csv-upload-area" id="dropZone" onclick="document.getElementById('csvFile').click()">
      <div style="font-size: 3rem; margin-bottom: 15px;">üìÑ</div>
      <h3 style="color: #3b82f6; margin-bottom: 10px;">Trascina qui il file CSV</h3>
      <p style="color: #64748b;">oppure clicca per selezionare</p>
      <input type="file" id="csvFile" accept=".csv" style="display:none;" onchange="handleCSV(event)">
      <button class="csv-template-btn" onclick="downloadTemplate(event)">
        üì• Scarica Template CSV
      </button>
    </div>

    <div id="csvPreview" style="display:none;">
      <h3 style="color: #1e293b; margin-bottom: 15px;">üìä Anteprima (Prime 5 righe)</h3>
      <div class="preview-table">
        <table id="previewTable"></table>
      </div>
      <p style="margin-top: 10px; color: #64748b; text-align: center;">
        Totale account da creare: <strong id="totalCount">0</strong>
      </p>
      <div class="bulk-actions">
        <button class="btn-cancel" onclick="cancelCSV()">‚ùå Annulla</button>
        <button class="btn-import" onclick="importCSV()">‚úÖ Importa Tutti</button>
      </div>
    </div>

    <div id="bulkSuccess" class="success-message" style="display:none;"></div>
  </div>

  <!-- Auto Generate Section -->
  <div id="autoSection" class="creation-section">
    <h2 style="margin-bottom: 20px; color: #1e293b;">ü§ñ Generazione Automatica</h2>
    
    <div class="auto-generate">
      <div class="auto-generate-card">
        <h4>üìö Classe</h4>
        <input type="text" id="autoClasse" placeholder="3B" maxlength="3">
        <p style="color: #64748b; font-size: 0.85rem;">es: 3A, 5C, 2B</p>
      </div>

      <div class="auto-generate-card">
        <h4>üë• Numero Studenti</h4>
        <input type="number" id="autoNumero" value="25" min="1" max="100">
        <p style="color: #64748b; font-size: 0.85rem;">Max 100 per volta</p>
      </div>

      <div class="auto-generate-card">
        <h4>üí∞ Token Iniziali</h4>
        <input type="number" id="autoToken" value="0" min="0">
        <p style="color: #64748b; font-size: 0.85rem;">Stesso per tutti</p>
      </div>
    </div>

    <div style="background: #fffbeb; border: 2px solid #fbbf24; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
      <h4 style="color: #92400e; margin-bottom: 10px;">‚ÑπÔ∏è Come funziona</h4>
      <p style="color: #78350f; margin-bottom: 10px;">Gli account verranno creati automaticamente con:</p>
      <ul style="color: #78350f; margin-left: 20px;">
        <li><strong>Username:</strong> studente1, studente2, studente3...</li>
        <li><strong>Password:</strong> classe+numero (es: 3B1, 3B2, 3B3...)</li>
        <li><strong>Nome:</strong> Studente 1, Studente 2, Studente 3...</li>
      </ul>
      <p style="color: #78350f; margin-top: 10px; font-size: 0.9rem;">üí° Potrai cambiare username e nome dopo la creazione</p>
    </div>

    <button class="quick-add-btn" onclick="autoGenerate()">
      üöÄ GENERA ACCOUNT
    </button>

    <div id="autoSuccess" class="success-message" style="display:none;"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    query,
    where,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDEN54mTu8CdsWoWvw0sP6xAfL2NRlAN9M",
    authDomain: "assemblea-token.firebaseapp.com",
    projectId: "assemblea-token",
    storageBucket: "assemblea-token.firebasestorage.app",
    messagingSenderId: "682305266240",
    appId: "1:682305266240:web:30a93bb05c10d1a2aeb5a5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Verifica admin
  if (typeof window.verificaSessione === 'function' && !window.verificaSessione()) {
    window.location.href = "login.html";
  }

  const isAdmin = localStorage.getItem("isAdmin");
  if (isAdmin !== "true") {
    alert("‚ö†Ô∏è Solo gli admin possono creare account");
    window.location.href = "login.html";
  }

  let csvData = [];

  // Select method
  window.selectMethod = function(method) {
    document.querySelectorAll('.method-card').forEach(card => card.classList.remove('active'));
    document.querySelectorAll('.creation-section').forEach(section => section.classList.remove('active'));

    event.target.closest('.method-card').classList.add('active');
    document.getElementById(method + 'Section').classList.add('active');
  };

  // Quick Add
  window.quickAdd = async function() {
    const username = document.getElementById('quickUsername').value.trim();
    const password = document.getElementById('quickPassword').value.trim();
    const nome = document.getElementById('quickNome').value.trim();
    const classe = document.getElementById('quickClasse').value.trim();
    const ruolo = document.getElementById('quickRuolo').value;
    const token = parseInt(document.getElementById('quickToken').value) || 0;

    if (!username || !password || !nome || !classe) {
      alert('‚ö†Ô∏è Compila tutti i campi obbligatori');
      return;
    }

    // Verifica username unico
    const q = query(collection(db, "studenti"), where("username", "==", username));
    const snap = await getDocs(q);
    if (!snap.empty) {
      alert('‚ùå Username gi√† esistente');
      return;
    }

    try {
      await addDoc(collection(db, "studenti"), {
        username,
        password,
        nome,
        classe,
        ruolo,
        token,
        attivo: true,
        creato: new Date()
      });

      document.getElementById('quickSuccess').style.display = 'block';
      setTimeout(() => {
        document.getElementById('quickSuccess').style.display = 'none';
        // Reset form
        document.getElementById('quickUsername').value = '';
        document.getElementById('quickPassword').value = '';
        document.getElementById('quickNome').value = '';
        document.getElementById('quickClasse').value = '';
        document.getElementById('quickToken').value = '0';
      }, 2000);

    } catch (error) {
      console.error(error);
      alert('‚ùå Errore creazione account');
    }
  };

  // CSV Template
  window.downloadTemplate = function(e) {
    e.stopPropagation();
    const csv = 'username,password,nome,classe,ruolo,token\nmario.rossi,1234,Mario Rossi,3B,studente,0\nluigi.verdi,1234,Luigi Verdi,3A,studente,0\nstand_panini,pass123,Stand Panini,Venditore,venditore,0';
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'template_account.csv';
    a.click();
  };

  // Handle CSV
  window.handleCSV = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      parseCSV(text);
    };
    reader.readAsText(file);
  };

  function parseCSV(text) {
    const lines = text.split('\n').filter(line => line.trim());
    const headers = lines[0].split(',').map(h => h.trim());
    
    csvData = [];
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(',').map(v => v.trim());
      if (values.length === headers.length) {
        const obj = {};
        headers.forEach((header, index) => {
          obj[header] = values[index];
        });
        csvData.push(obj);
      }
    }

    showPreview();
  }

  function showPreview() {
    const preview = csvData.slice(0, 5);
    const table = document.getElementById('previewTable');
    
    let html = '<thead><tr>';
    Object.keys(preview[0]).forEach(key => {
      html += `<th>${key}</th>`;
    });
    html += '</tr></thead><tbody>';

    preview.forEach(row => {
      html += '<tr>';
      Object.values(row).forEach(val => {
        html += `<td>${val}</td>`;
      });
      html += '</tr>';
    });
    html += '</tbody>';

    table.innerHTML = html;
    document.getElementById('totalCount').textContent = csvData.length;
    document.getElementById('csvPreview').style.display = 'block';
  }

  window.cancelCSV = function() {
    csvData = [];
    document.getElementById('csvPreview').style.display = 'none';
    document.getElementById('csvFile').value = '';
  };

  window.importCSV = async function() {
    if (!confirm(`Creare ${csvData.length} account?`)) return;

    let created = 0;
    let errors = 0;

    for (const account of csvData) {
      try {
        await addDoc(collection(db, "studenti"), {
          username: account.username,
          password: account.password,
          nome: account.nome,
          classe: account.classe,
          ruolo: account.ruolo || 'studente',
          token: parseInt(account.token) || 0,
          attivo: true,
          creato: new Date()
        });
        created++;
      } catch (error) {
        errors++;
      }
    }

    const successDiv = document.getElementById('bulkSuccess');
    successDiv.innerHTML = `‚úÖ ${created} account creati con successo!${errors > 0 ? `<br>‚ö†Ô∏è ${errors} errori` : ''}`;
    successDiv.style.display = 'block';
    
    cancelCSV();
  };

  // Auto Generate
  window.autoGenerate = async function() {
    const classe = document.getElementById('autoClasse').value.trim().toUpperCase();
    const numero = parseInt(document.getElementById('autoNumero').value);
    const tokenIniziali = parseInt(document.getElementById('autoToken').value) || 0;

    if (!classe || numero < 1 || numero > 100) {
      alert('‚ö†Ô∏è Inserisci classe e numero valido (1-100)');
      return;
    }

    if (!confirm(`Generare ${numero} account per la classe ${classe}?`)) return;

    let created = 0;
    const accounts = [];

    for (let i = 1; i <= numero; i++) {
      try {
        const username = `studente${i}`;
        const password = `${classe}${i}`;
        const nome = `Studente ${i}`;

        await addDoc(collection(db, "studenti"), {
          username,
          password,
          nome,
          classe,
          ruolo: 'studente',
          token: tokenIniziali,
          attivo: true,
          creato: new Date()
        });

        accounts.push({ username, password, nome });
        created++;
      } catch (error) {
        console.error(error);
      }
    }

    const successDiv = document.getElementById('autoSuccess');
    successDiv.innerHTML = `‚úÖ ${created} account creati!<br><br>üìã Credenziali generate salvate. Scarica il PDF per distribuire.`;
    successDiv.style.display = 'block';

    // Opzionale: Genera PDF con credenziali
    generateCredentialsPDF(accounts, classe);
  };

  function generateCredentialsPDF(accounts, classe) {
    // Qui potresti integrare jsPDF per generare un PDF
    // Per ora creiamo un file di testo
    let text = `CREDENZIALI ACCESSO - CLASSE ${classe}\n\n`;
    accounts.forEach(acc => {
      text += `Nome: ${acc.nome}\nUsername: ${acc.username}\nPassword: ${acc.password}\n\n`;
    });

    const blob = new Blob([text], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `credenziali_${classe}.txt`;
    a.click();
  }

  // Drag & Drop
  const dropZone = document.getElementById('dropZone');
  
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    
    const file = e.dataTransfer.files[0];
    if (file && file.name.endsWith('.csv')) {
      const reader = new FileReader();
      reader.onload = (e) => parseCSV(e.target.result);
      reader.readAsText(file);
    }
  });
</script>

</body>
</html>