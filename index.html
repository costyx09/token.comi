<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Studente</title>
  <link rel="stylesheet" href="style.css">
  <script src="session-manager.js"></script>
</head>
<body>

<div class="app">
  <header>
    <h1 id="nomeStudente">La tua Dashboard</h1>
    <button id="logoutBtn" class="logout-btn">Esci</button>
  </header>

  <div class="token-card">
    <p>Token disponibili</p>
    <h2 id="token">0</h2>
  </div>

  <button id="scanBtn" onclick="window.location.href='scanner.html'">Scansiona QR</button>

  <div class="storico">
    <div class="storico-header">
      <h3>Storico Transazioni</h3>
      <button id="toggleStorico" class="toggle-btn">Mostra tutto</button>
    </div>
    <ul id="listaStorico">
      <li class="loading">Caricamento...</li>
    </ul>
  </div>
</div>

<!-- Dark Mode Toggle -->
<button id="darkModeToggle" class="dark-mode-toggle">üåô</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { 
    getFirestore, 
    doc, 
    getDoc, 
    updateDoc,
    collection,
    addDoc,
    query,
    where,
    orderBy,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDEN54mTu8CdsWoWvw0sP6xAfL2NRlAN9M",
    authDomain: "assemblea-token.firebaseapp.com",
    projectId: "assemblea-token",
    storageBucket: "assemblea-token.firebasestorage.app",
    messagingSenderId: "682305266240",
    appId: "1:682305266240:web:30a93bb05c10d1a2aeb5a5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // üîí PROTEZIONE: Verifica se l'utente √® loggato come studente
  const studenteID = localStorage.getItem("studenteID");
  const ruoloUtente = localStorage.getItem("ruoloUtente");
  
  // Verifica sessione valida
  if (typeof window.verificaSessione === 'function' && !window.verificaSessione()) {
    window.location.href = "login.html";
  }
  
  if (!studenteID || ruoloUtente !== "studente") {
    alert("‚ö†Ô∏è Questa pagina √® solo per studenti");
    window.location.href = "login.html";
  }

  const tokenSpan = document.getElementById("token");
  const storico = document.getElementById("listaStorico");
  const logoutBtn = document.getElementById("logoutBtn");
  const nomeStudente = document.getElementById("nomeStudente");
  const toggleStorico = document.getElementById("toggleStorico");

  let storicoCompleto = false; // Stato dello storico (compresso o completo)
  let transazioniCaricate = []; // Array con tutte le transazioni

  // Carica il nome dello studente
  const nomeStorage = localStorage.getItem("studenteNome");
  if (nomeStorage) {
    nomeStudente.textContent = `Ciao ${nomeStorage}!`;
  }

  // Funzione per caricare i token
  async function caricaToken() {
    try {
      const ref = doc(db, "studenti", studenteID);
      const snap = await getDoc(ref);
      
      if (snap.exists()) {
        tokenSpan.textContent = snap.data().token || 0;
      } else {
        alert("‚ùå Studente non trovato");
        logout();
      }
    } catch (error) {
      console.error("Errore caricamento token:", error);
      alert("‚ùå Errore di connessione");
    }
  }

  // Funzione per caricare lo storico
  async function caricaStorico() {
    try {
      storico.innerHTML = "";

      // Query SENZA orderBy per evitare errore indice
      const q = query(
        collection(db, "transazioni"),
        where("studente", "==", studenteID)
      );

      const snap = await getDocs(q);

      if (snap.empty) {
        storico.innerHTML = '<li style="text-align: center; color: #94a3b8;">Nessuna transazione</li>';
        toggleStorico.style.display = 'none';
        return;
      }

      // Ordina le transazioni lato client
      transazioniCaricate = [];
      snap.forEach(docSnap => {
        const data = docSnap.data();
        transazioniCaricate.push(data);
      });

      // Ordina per timestamp in ordine decrescente
      transazioniCaricate.sort((a, b) => {
        const timeA = a.timestamp?.toDate?.() || new Date(0);
        const timeB = b.timestamp?.toDate?.() || new Date(0);
        return timeB - timeA;
      });

      // Mostra solo le prime 3 o tutte
      mostraStorico();

      // Mostra/nascondi il bottone in base al numero di transazioni
      if (transazioniCaricate.length > 3) {
        toggleStorico.style.display = 'block';
      } else {
        toggleStorico.style.display = 'none';
      }

    } catch (error) {
      console.error("Errore caricamento storico:", error);
      storico.innerHTML = '<li style="text-align: center; color: #ef4444;">Errore caricamento storico</li>';
    }
  }

  // Funzione per mostrare lo storico (3 o tutte)
  function mostraStorico() {
    storico.innerHTML = '';

    const transazioniDaMostrare = storicoCompleto 
      ? transazioniCaricate 
      : transazioniCaricate.slice(0, 3);

    // Crea gli elementi della lista
    transazioniDaMostrare.forEach(data => {
      const li = document.createElement("li");
      
      // Aggiungi classe per transazioni positive
      if (data.variazione > 0) {
        li.classList.add("positivo");
      }
      
      // Formatta la data
      let dataStr = "Oggi";
      if (data.timestamp && data.timestamp.toDate) {
        const date = data.timestamp.toDate();
        const oggi = new Date();
        const ieri = new Date(oggi);
        ieri.setDate(ieri.getDate() - 1);
        
        if (date.toDateString() === oggi.toDateString()) {
          dataStr = `Oggi, ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        } else if (date.toDateString() === ieri.toDateString()) {
          dataStr = `Ieri, ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        } else {
          dataStr = date.toLocaleDateString('it-IT');
        }
      }
      
      const descrizione = data.descrizione || "Transazione";
      const variazione = data.variazione;
      const segno = variazione > 0 ? '+' : '';
      
      li.innerHTML = `
        <span>${segno}${variazione} Token</span>
        <small>${descrizione}</small>
      `;
      
      // Aggiungi data
      li.setAttribute('data-time', dataStr);
      
      storico.appendChild(li);
    });

    // Aggiorna il testo del bottone
    if (transazioniCaricate.length > 3) {
      toggleStorico.textContent = storicoCompleto ? 'Mostra meno' : 'Mostra tutto';
    }
  }

  // Click sul bottone toggle storico
  toggleStorico.addEventListener("click", () => {
    storicoCompleto = !storicoCompleto;
    mostraStorico();
  });

  // Logout
  function logout() {
    localStorage.removeItem("studenteID");
    localStorage.removeItem("studenteNome");
    localStorage.removeItem("isAdmin");
    localStorage.removeItem("ruoloUtente");
    window.location.href = "login.html";
  }

  logoutBtn.addEventListener("click", () => {
    if (confirm("Vuoi davvero uscire?")) {
      logout();
    }
  });

  // Carica i dati all'avvio
  caricaToken();
  caricaStorico();

  // Dark Mode Toggle
  const darkModeToggle = document.getElementById("darkModeToggle");
  const isDarkMode = localStorage.getItem("darkMode") === "true";
  
  if (isDarkMode) {
    document.body.classList.add("dark-mode");
    darkModeToggle.textContent = "‚òÄÔ∏è";
  }

  darkModeToggle.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    const isNowDark = document.body.classList.contains("dark-mode");
    localStorage.setItem("darkMode", isNowDark);
    darkModeToggle.textContent = isNowDark ? "‚òÄÔ∏è" : "üåô";
  });
</script>

</body>
</html>
